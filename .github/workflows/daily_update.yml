name: Daily Content Update

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹åŒ—äº¬æ—¶é—´ = UTC 18:00 (å‰ä¸€å¤©)
    - cron: '0 18 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests supabase beautifulsoup4 html2text

      - name: ðŸ¤– Fetch GitHub Trending with AI Summary
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        run: |
          cd scripts

          echo "=========================================="
          echo "ðŸš€ å¼€å§‹æ¯æ—¥ä¿¡æ¯æ”¶é›† ($(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') åŒ—äº¬æ—¶é—´)"
          echo "=========================================="

          # ==================== GitHub Trending ====================
          echo ""
          echo "ðŸ“¦ [1/3] æŠ“å– GitHub çƒ­é—¨é¡¹ç›® (AI æ‘˜è¦)..."

          # æŠ“å–å¤šè¯­è¨€çƒ­é—¨é¡¹ç›®ï¼Œæ¯ç§è¯­è¨€å–5ä¸ªï¼Œå…±çº¦15-20ä¸ª
          python fetch_github_trending.py \
            --limit 8 \
            --ai \
            --upload \
            --supabase-url "$SUPABASE_URL" \
            --supabase-key "$SUPABASE_KEY" \
            || echo "âš ï¸ é€šç”¨é¡¹ç›®æŠ“å–å¤±è´¥ï¼Œç»§ç»­..."

          # Python é¡¹ç›®ï¼ˆAI å±…å¤šï¼‰
          python fetch_github_trending.py \
            --language python \
            --limit 5 \
            --ai \
            --upload \
            --supabase-url "$SUPABASE_URL" \
            --supabase-key "$SUPABASE_KEY" \
            || echo "âš ï¸ Python é¡¹ç›®æŠ“å–å¤±è´¥ï¼Œç»§ç»­..."

          # TypeScript é¡¹ç›®ï¼ˆå‰ç«¯å·¥å…·å±…å¤šï¼‰
          python fetch_github_trending.py \
            --language typescript \
            --limit 5 \
            --ai \
            --upload \
            --supabase-url "$SUPABASE_URL" \
            --supabase-key "$SUPABASE_KEY" \
            || echo "âš ï¸ TypeScript é¡¹ç›®æŠ“å–å¤±è´¥ï¼Œç»§ç»­..."

          # Rust é¡¹ç›®ï¼ˆé«˜æ€§èƒ½å·¥å…·ï¼‰
          python fetch_github_trending.py \
            --language rust \
            --limit 3 \
            --ai \
            --upload \
            --supabase-url "$SUPABASE_URL" \
            --supabase-key "$SUPABASE_KEY" \
            || echo "âš ï¸ Rust é¡¹ç›®æŠ“å–å¤±è´¥ï¼Œç»§ç»­..."

          echo "âœ… GitHub Trending æŠ“å–å®Œæˆ"

          # ==================== åŽå·¥æ•™åŠ¡é€šçŸ¥ ====================
          # æš‚æ—¶ç¦ç”¨ï¼šéœ€è¦ SSO ç»Ÿä¸€è®¤è¯ï¼ŒGitHub Actions æ— æ³•è‡ªåŠ¨ç™»å½•
          # å¦‚éœ€ä½¿ç”¨ï¼Œè¯·åœ¨æ ¡å›­ç½‘çŽ¯å¢ƒä¸‹æ‰‹åŠ¨è¿è¡Œï¼š
          #   cd scripts
          #   python fetch_scut_jw.py --upload --supabase-url "..." --supabase-key "..."
          #
          # echo ""
          # echo "ðŸ« [2/3] æŠ“å–åŽå·¥æ•™åŠ¡é€šçŸ¥..."
          #
          # python fetch_scut_jw.py \
          #   --upload \
          #   --supabase-url "$SUPABASE_URL" \
          #   --supabase-key "$SUPABASE_KEY" \
          #   || echo "âš ï¸ æ•™åŠ¡é€šçŸ¥æŠ“å–å¤±è´¥ï¼Œç»§ç»­..."
          #
          # echo "âœ… æ•™åŠ¡é€šçŸ¥æŠ“å–å®Œæˆ"

          # ==================== å®Œæˆ ====================
          echo ""
          echo "=========================================="
          echo "ðŸŽ‰ æ¯æ—¥ä¿¡æ¯æ”¶é›†å®Œæˆï¼"
          echo "â° å®Œæˆæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') åŒ—äº¬æ—¶é—´"
          echo "=========================================="

      - name: ðŸ“Š Summary
        if: always()
        run: |
          echo "### ðŸ“± Anthropo-Reader æ¯æ—¥æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- â° è¿è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S') åŒ—äº¬æ—¶é—´" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– AI æ‘˜è¦: å·²å¯ç”¨ (ç¡…åŸºæµåŠ¨)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ æ•°æ®æ¥æº: GitHub Trending + åŽå·¥æ•™åŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ‰“å¼€ App å³å¯æŸ¥çœ‹æœ€æ–°å†…å®¹ï¼" >> $GITHUB_STEP_SUMMARY
